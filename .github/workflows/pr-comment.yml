name: PR Comment - Test Results

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed

permissions:
  pull-requests: write
  contents: read

jobs:
  comment:
    name: Post Test Results
    runs-on: ubuntu-latest
    if: >
      github.event.workflow_run.event == 'pull_request' &&
      github.event.workflow_run.conclusion == 'success'

    steps:
      - name: Download backend coverage artifact
        uses: actions/download-artifact@v4
        with:
          name: backend-coverage
          path: backend-coverage
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}
        continue-on-error: true

      - name: Download frontend coverage artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-coverage
          path: frontend-coverage
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}
        continue-on-error: true

      - name: Extract coverage percentages
        id: coverage
        run: |
          # Extract backend coverage
          if [ -f "backend-coverage/coverage-summary.json" ]; then
            BACKEND_COV=$(cat backend-coverage/coverage-summary.json | \
              grep -o '"total":{"lines":{"total":[0-9]*,"covered":[0-9]*' | \
              grep -o '[0-9]*' | awk 'NR==1{total=$1} NR==2{covered=$1} END{if(total>0) printf "%.1f", (covered/total)*100; else print "0"}')
          else
            BACKEND_COV="N/A"
          fi

          # Extract frontend coverage
          if [ -f "frontend-coverage/coverage-summary.json" ]; then
            FRONTEND_COV=$(cat frontend-coverage/coverage-summary.json | \
              grep -o '"total":{"lines":{"total":[0-9]*,"covered":[0-9]*' | \
              grep -o '[0-9]*' | awk 'NR==1{total=$1} NR==2{covered=$1} END{if(total>0) printf "%.1f", (covered/total)*100; else print "0"}')
          else
            FRONTEND_COV="N/A"
          fi

          echo "backend=$BACKEND_COV" >> $GITHUB_OUTPUT
          echo "frontend=$FRONTEND_COV" >> $GITHUB_OUTPUT

      - name: Get PR number
        id: pr
        run: |
          PR_NUMBER=$(jq -r '.workflow_run.pull_requests[0].number' <<< "${{ toJSON(github.event) }}")
          echo "number=$PR_NUMBER" >> $GITHUB_OUTPUT

      - name: Post PR comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = ${{ steps.pr.outputs.number }};
            const backendCov = '${{ steps.coverage.outputs.backend }}';
            const frontendCov = '${{ steps.coverage.outputs.frontend }}';

            const comment = `## ✅ Test Results

            | Package | Status | Coverage |
            |---------|--------|----------|
            | Backend | ✅ Pass | ${backendCov}% |
            | Frontend | ✅ Pass | ${frontendCov}% |

            > Workflow run: [#${{ github.event.workflow_run.run_number }}](${{ github.event.workflow_run.html_url }})`;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('## ✅ Test Results')
            );

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: comment
              });
            }
